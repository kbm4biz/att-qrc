<!DOCTYPE html>
<html>
<head>
    <title>QR Test Scanner</title>
    <style>
        /* Same styles as previous version */
    </style>
</head>
<body>
    <h1>QR Code Test Scanner</h1>
    
    <div id="scanner-box">
        <video id="video-element" playsinline autoplay></video>
        <div id="scan-frame"></div>
    </div>
    
    <div id="result">Initializing scanner...</div>
    
    <button onclick="toggleScanner()" id="toggleBtn">Start Scanner</button>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        let isScanning = false;
        let videoStream = null;
        const video = document.getElementById('video-element');
        const resultDiv = document.getElementById('result');
        const toggleBtn = document.getElementById('toggleBtn');

        async function toggleScanner() {
            if (!isScanning) {
                await startScanner();
            } else {
                stopScanner();
            }
        }

        async function startScanner() {
            try {
                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 }
                    }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                
                // Wait for video to start playing
                await new Promise((resolve) => {
                    video.onplaying = resolve;
                });

                isScanning = true;
                toggleBtn.textContent = 'Stop Scanner';
                resultDiv.textContent = 'Scanning...';
                scanFrame();
            } catch (err) {
                handleCameraError(err);
            }
        }

        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    track.stop();
                });
            }
            isScanning = false;
            toggleBtn.textContent = 'Start Scanner';
            resultDiv.textContent = 'Scanner stopped';
            video.srcObject = null;
        }

        function scanFrame() {
            if (!isScanning) return;

            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    handleQRCode(code.data);
                } else {
                    requestAnimationFrame(scanFrame);
                }
            } catch (err) {
                handleScanError(err);
            }
        }

        function handleQRCode(data) {
            const isValid = data.startsWith('VALID_');
            resultDiv.textContent = isValid ? `Valid: ${data}` : `Invalid: ${data}`;
            resultDiv.className = isValid ? 'valid' : 'invalid';
            
            // Continue scanning
            requestAnimationFrame(scanFrame);
        }

        function handleCameraError(err) {
            console.error('Camera Error:', err);
            resultDiv.className = 'invalid';
            resultDiv.textContent = `Camera Error: ${err.name}`;
            if (err.name === 'NotAllowedError') {
                resultDiv.textContent += ' - Please allow camera access';
            }
        }

        function handleScanError(err) {
            console.error('Scan Error:', err);
            resultDiv.className = 'invalid';
            resultDiv.textContent = 'Scanning Error - Please try again';
            stopScanner();
        }

        // Cleanup on exit
        window.addEventListener('beforeunload', () => {
            stopScanner();
        });
    </script>
</body>
</html>
